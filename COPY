import javazoom.jl.decoder.*;
import javax.sound.sampled.*;
import java.io.*;

public class Mp3ToWavJLayer {
    public static void main(String[] args) throws IOException {
        File mp3File = new File("input.mp3");
        File wavFile = new File("output.wav");
        convertMp3ToWav(mp3File, wavFile);
        System.out.println("Конвертация завершена: " + wavFile.getAbsolutePath());
    }

    public static void convertMp3ToWav(File mp3, File wav) throws IOException {
        try (FileInputStream fis = new FileInputStream(mp3);
             BufferedInputStream bis = new BufferedInputStream(fis);
             FileOutputStream fos = new FileOutputStream(wav)) {

            Bitstream bitstream = new Bitstream(bis);
            Decoder decoder = new Decoder();
            AudioFormat format = new AudioFormat(44100, 16, 2, true, false);

            ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
            try {
                Header header;
                while ((header = bitstream.readFrame()) != null) {
                    SampleBuffer buffer = (SampleBuffer) decoder.decodeFrame(header, bitstream);
                    short[] samples = buffer.getBuffer();

                    for (short sample : samples) {
                        byteArrayOutputStream.write(sample & 0xFF);
                        byteArrayOutputStream.write((sample >> 8) & 0xFF);
                    }
                    bitstream.closeFrame();
                }

                byte[] pcmData = byteArrayOutputStream.toByteArray();

                // Создаем AudioInputStream с точной длиной данных
                ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(pcmData);
                AudioInputStream audioStream = new AudioInputStream(byteArrayInputStream, format, pcmData.length / format.getFrameSize());

                // Записываем WAV
                AudioSystem.write(audioStream, AudioFileFormat.Type.WAVE, fos);
            } catch (JavaLayerException e) {
                throw new IOException("Ошибка декодирования MP3", e);
            }
        }
    }
}
